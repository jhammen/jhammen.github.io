<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Untitled :: Jakarta EE Documentation</title>
    <meta name="generator" content="Antora 3.1.3">
    <link rel="stylesheet" href="../../../../_/css/site.css">
    <script>var uiRootPath = '../../../../_'</script>
    <script>!function (theme) {
        if (theme === 'dark') document.documentElement.classList.add('theme-dark')
      }(localStorage && localStorage.getItem('theme') || (matchMedia('(prefers-color-scheme: dark)') && 'dark'))
    </script>
      </head>
  <body class="article">
<header class="header">
  <nav class="navbar">
    <div class="navbar-brand">
      <a id="site-title" class="navbar-item" href="../../../..">Jakarta EE Documentation</a>
      <button class="navbar-burger" data-target="topbar-nav">
        <span></span>
        <span></span>
        <span></span>
      </button>
    </div>
    <div id="topbar-nav" class="navbar-menu">
      <div class="navbar-end">
<!--
        <a class="navbar-item" href="#">Home</a>
        <div class="navbar-item has-dropdown is-hoverable">
          <a class="navbar-link" href="#">Products</a>
          <div class="navbar-dropdown">
            <a class="navbar-item" href="#">Product A</a>
            <a class="navbar-item" href="#">Product B</a>
            <a class="navbar-item" href="#">Product C</a>
          </div>
        </div>
        <div class="navbar-item has-dropdown is-hoverable">
          <a class="navbar-link" href="#">Services</a>
          <div class="navbar-dropdown">
            <a class="navbar-item" href="#">Service A</a>
            <a class="navbar-item" href="#">Service B</a>
            <a class="navbar-item" href="#">Service C</a>
          </div>
        </div>
 -->
        <div class="navbar-item">
          <span class="control">
            <a class="button is-primary" href="../../../../jakartaee-tutorial/10/jakarta-ee-tutorial.pdf">Download</a>
          </span>
        </div>
      </div>
      <div class="navbar-theme-switcher">
        <span class="switch" title="Switch between Light and Dark Theme">
          <input id="theme-switcher-checkbox" type="checkbox" />
          <label for="theme-switcher-checkbox">Dark Theme</label>
        </span>
      </div>
    </div>
  </nav>
</header>
<div class="body">
<div class="nav-container" data-component="jakartaee-tutorial" data-version="10">
  <div class="toolbar"></div>
  <aside class="nav">
    <div class="panels">
<div class="nav-panel-menu is-active" data-panel="menu">
  <nav class="nav-menu">
    <h3 class="title"><a href="../../index.html">Jakarta EE Tutorial</a></h3>
<ul class="nav-list">
  <li class="nav-item" data-depth="0">
    <button class="nav-item-toggle"></button>
    <span class="nav-text">Introduction</span>
<ul class="nav-list">
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="../../index.html">Preface</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="../../intro/overview/overview.html">Overview</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="../../intro/usingexamples/usingexamples.html">Using the Tutorial Examples</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="0">
    <button class="nav-item-toggle"></button>
    <span class="nav-text">Jakarta EE Core Profile</span>
<ul class="nav-list">
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <span class="nav-text">Jakarta CDI Lite</span>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../../cdi/cdi-basic/cdi-basic.html">Introduction to Jakarta Contexts and Dependency Injection</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../../cdi/cdi-basicexamples/cdi-basicexamples.html">Running the Basic Contexts and Dependency Injection Examples</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../../supporttechs/interceptors/interceptors.html">Using Jakarta EE Interceptors</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <span class="nav-text">Jakarta REST</span>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../../websvcs/jaxrs/jaxrs.html">Building RESTful Web Services with Jakarta REST</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../../websvcs/jaxrs-client/jaxrs-client.html">Accessing REST Resources with the Jakarta REST Client API</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../../websvcs/jaxrs-advanced/jaxrs-advanced.html">Jakarta REST: Advanced Topics and an Example</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <span class="nav-text">Jakarta JSON</span>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../../web/jsonb/jsonb.html">JSON Binding</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../../web/jsonp/jsonp.html">JSON Processing</a>
  </li>
</ul>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="0">
    <button class="nav-item-toggle"></button>
    <span class="nav-text">Jakarta EE Web Profile</span>
<ul class="nav-list">
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <span class="nav-text">Jakarta CDI Full</span>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../../cdi/cdi-adv/cdi-adv.html">Jakarta Contexts and Dependency Injection: Advanced Topics</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../../cdi/cdi-bootstrap-se8/cdi-bootstrap-se8.html">Bootstrapping a CDI Container in Java SE</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../../cdi/cdi-adv-examples/cdi-adv-examples.html">Running the Advanced Contexts and Dependency Injection Examples</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <span class="nav-text">Jakarta Validation</span>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../../beanvalidation/bean-validation/bean-validation.html">Introduction to Jakarta Bean Validation</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../../beanvalidation/bean-validation-advanced/bean-validation-advanced.html">Bean Validation: Advanced Topics</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="../../security/security.html">Jakarta Security</a>
  </li>
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <span class="nav-text">Jakarta Servlets</span>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../../web/webapp/webapp.html">Getting Started with Web Applications</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../../web/servlets/servlets.html">Jakarta Servlet Technology</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <span class="nav-text">Jakarta Faces</span>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../../web/faces-intro/faces-intro.html">Jakarta Faces Technology</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../../web/faces-facelets/faces-facelets.html">Introduction to Facelets</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../../web/faces-page/faces-page.html">Using Jakarta Faces Technology in Web Pages</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../../web/faces-page-core/faces-page-core.html">Using Converters, Listeners, and Validators</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../../web/faces-develop/faces-develop.html">Developing with Jakarta Faces Technology</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../../web/faces-ajax/faces-ajax.html">Using Ajax with Jakarta Faces Technology</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../../web/faces-advanced-cc/faces-advanced-cc.html">Composite Components: Advanced Topics and an Example</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../../web/faces-custom/faces-custom.html">Creating Custom UI Components and Other Custom Objects</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../../web/faces-configure/faces-configure.html">Configuring Jakarta Faces Applications</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../../web/faces-ws/faces-ws.html">Using WebSockets with Jakarta Faces Technology</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../../web/webi18n/webi18n.html">Internationalizing and Localizing Web Applications</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="../../web/websocket/websocket.html">Jakarta WebSocket</a>
  </li>
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <span class="nav-text">Jakarta Persistence</span>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../../persist/persistence-intro/persistence-intro.html">Introduction to Jakarta Persistence</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../../persist/persistence-basicexamples/persistence-basicexamples.html">Running the Persistence Examples</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../../persist/persistence-querylanguage/persistence-querylanguage.html">The Jakarta Persistence Query Language</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../../persist/persistence-criteria/persistence-criteria.html">Using the Criteria API to Create Queries</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../../persist/persistence-string-queries/persistence-string-queries.html">Creating and Using String-Based Criteria Queries</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../../persist/persistence-locking/persistence-locking.html">Controlling Concurrent Access to Entity Data with Locking</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../../persist/persistence-entitygraphs/persistence-entitygraphs.html">Creating Fetch Plans with Entity Graphs</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../../persist/persistence-cache/persistence-cache.html">Using a Second-Level Cache with Jakarta Persistence Applications</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <span class="nav-text">Jakarta Enterprise Beans Lite</span>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../../entbeans/ejb-intro/ejb-intro.html">Enterprise Beans</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../../entbeans/ejb-gettingstarted/ejb-gettingstarted.html">Getting Started with Enterprise Beans</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../../entbeans/ejb-basicexamples/ejb-basicexamples.html">Running the Enterprise Bean Examples</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../../entbeans/ejb-async/ejb-async.html">Using Asynchronous Method Invocation in Session Beans</a>
  </li>
</ul>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="0">
    <button class="nav-item-toggle"></button>
    <span class="nav-text">Jakarta EE Platform</span>
<ul class="nav-list">
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="../mail-api/mail-api.html">Jakarta Mail</a>
  </li>
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <span class="nav-text">Jakarta Messaging</span>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../jms-concepts/jms-concepts.html">Jakarta Messaging Concepts</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="jms-examples.html">Jakarta Messaging Examples</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="../../supporttechs/batch-processing/batch-processing.html">Jakarta Batch</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="0">
    <button class="nav-item-toggle"></button>
    <span class="nav-text">Advanced</span>
<ul class="nav-list">
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <span class="nav-text">Web Profile</span>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../../security/security-authentication/security-authentication.html">Jakarta Authentication</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../../security/security-authorization/security-authorization.html">Jakarta Authorization</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../../supporttechs/transactions/transactions.html">Jakarta Transactions</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../../supporttechs/concurrency-utilities/concurrency-utilities.html">Jakarta Concurrency</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <span class="nav-text">Jakarta EE Platform</span>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../../supporttechs/connectors/connectors.html">Jakarta Connectors</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <span class="nav-text">Optional Components</span>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../../web/faces-el/faces-el.html">Jakarta Expression Language</a>
  </li>
  <li class="nav-item" data-depth="2">
    <span class="nav-text">Jakarta XML Binding</span>
  </li>
</ul>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="0">
    <button class="nav-item-toggle"></button>
    <span class="nav-text">Archived</span>
<ul class="nav-list">
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <span class="nav-text">Web Profile</span>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../../web/jakarta-pages/jakarta-pages.html">Jakarta Pages</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../../web/jakarta-tags/jakarta-tags.html">Jakarta Tags</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <span class="nav-text">Jakarta EE Platform</span>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../../websvcs/xml-websvcs/xml-websvcs.html">XML Web Services</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../../entbeans/ejb-full/ejb-full.html">Jakarta Enterprise Beans Full</a>
  </li>
</ul>
  </li>
</ul>
  </li>
</ul>
  </nav>
</div>
<div class="nav-panel-explore" data-panel="explore">
  <div class="context">
    <span class="title">Jakarta EE Tutorial</span>
    <span class="version">10</span>
  </div>
  <ul class="components">
    <li class="component is-current">
      <a class="title" href="../../index.html">Jakarta EE Tutorial</a>
      <ul class="versions">
        <li class="version is-current is-latest">
          <a href="../../index.html">10</a>
        </li>
        <li class="version">
          <a href="../../../9.1/index.html">9.1</a>
        </li>
      </ul>
    </li>
  </ul>
</div>
    </div>
  </aside>
</div>
<main class="article">
<div class="toolbar" role="navigation">
<button class="nav-toggle"></button>
  <a href="../../index.html" class="home-link"></a>
<nav class="breadcrumbs" aria-label="breadcrumbs">
</nav>
<div class="page-versions">
  <button class="version-menu-toggle" title="Show other versions of page">10</button>
  <div class="version-menu">
    <a class="version is-current" href="jms-examples009.html">10</a>
    <a class="version" href="../../../9.1/messaging/jms-examples/jms-examples009.html">9.1</a>
  </div>
</div>
  <div class="edit-this-page"><a href="https://github.com/jhammen/jakartaee-tutorial/edit/main/src/main/antora/modules/messaging/pages/jms-examples/jms-examples009.adoc">Edit this Page</a></div>
  </div>
  <div class="content">
<aside class="toc sidebar" data-title="Contents" data-levels="2">
  <div class="toc-menu"></div>
</aside>
<article class="doc">
<div class="sect1">
<h2 id="_using_an_entity_to_join_messages_from_two_mdbs"><a class="anchor" href="#_using_an_entity_to_join_messages_from_two_mdbs"></a>Using an Entity to Join Messages from Two MDBs</h2>
<div class="sectionbody">
<div class="paragraph">
<p>This section explains how to write, compile, package, deploy, and run an application that uses the Jakarta Messaging with an entity.
The application uses the following components:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>An application client that both sends and receives messages</p>
</li>
<li>
<p>Two message-driven beans</p>
</li>
<li>
<p>An entity class</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>You will find the source files for this section in the <code><em>jakartaee-examples</em>/tutorial/jms/clientmdbentity/</code> directory.
Path names in this section are relative to this directory.</p>
</div>
<div class="sect2">
<h3 id="_overview_of_the_clientmdbentity_example_application"><a class="anchor" href="#_overview_of_the_clientmdbentity_example_application"></a>Overview of the clientmdbentity Example Application</h3>
<div class="paragraph">
<p>This application simulates, in a simplified way, the work flow of a company&#8217;s human resources (HR) department when it processes a new hire.
This application also demonstrates how to use the Jakarta EE platform to accomplish a task that many Messaging applications need to perform.</p>
</div>
<div class="paragraph">
<p>A messaging client must often wait for several messages from various sources.
It then uses the information in all these messages to assemble a message that it then sends to another destination.
The common term for this design pattern (which is not specific to Jakarta Messaging) is joining messages.
Such a task must be transactional, with all the receives and the send as a single transaction.
If not all the messages are received successfully, the transaction can be rolled back.
For an application client example that illustrates this task, see <a href="jms-examples.html#_using_local_transactions" class="xref page">Using Local Transactions</a>.</p>
</div>
<div class="paragraph">
<p>A message-driven bean can process only one message at a time in a transaction.
To provide the ability to join messages, an application can have the message-driven bean store the interim information in a Jakarta Persistence entity.
The entity can then determine whether all the information has been received; when it has, the entity can report this back to one of the message-driven beans, which then creates and sends the message to the other destination.
After it has completed its task, the entity can be removed.</p>
</div>
<div class="paragraph">
<p>The basic steps of the application are as follows.</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>The HR department&#8217;s application client generates an employee ID for each new hire and then publishes a message (M1) containing the new hire&#8217;s name, employee ID, and position.
It publishes the message to a topic because the message needs to be consumed by two message-driven beans.
The client then creates a temporary queue, <code>ReplyQueue</code>, with a message listener that waits for a reply to the message.
(See <a href="../jms-concepts/jms-concepts.html#_creating_temporary_destinations" class="xref page">Creating Temporary Destinations</a> for more information.)</p>
</li>
<li>
<p>Two message-driven beans process each message: One bean, <code>OfficeMDB</code>, assigns the new hire&#8217;s office number, and the other bean, <code>EquipmentMDB</code>, assigns the new hire&#8217;s equipment.
The first bean to process the message creates and persists an entity named <code>SetupOffice</code>, then calls a business method of the entity to store the information it has generated.
The second bean locates the existing entity and calls another business method to add its information.</p>
</li>
<li>
<p>When both the office and the equipment have been assigned, the entity business method returns a value of <code>true</code> to the message-driven bean that called the method.
The message-driven bean then sends to the reply queue a message (M2) describing the assignments.
Then it removes the entity.
The application client&#8217;s message listener retrieves the information.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p><a href="#_an_enterprise_bean_application_client_to_message_driven_beans_to_entity">Figure 1, &#8220;An Enterprise Bean Application: Client to Message-Driven Beans to Entity&#8221;</a> illustrates the structure of this application.
Of course, an actual HR application would have more components; other beans could set up payroll and benefits records, schedule orientation, and so on.</p>
</div>
<div class="paragraph">
<p><a href="#_an_enterprise_bean_application_client_to_message_driven_beans_to_entity">Figure 1, &#8220;An Enterprise Bean Application: Client to Message-Driven Beans to Entity&#8221;</a> assumes that <code>OfficeMDB</code> is the first message-driven bean to consume the message from the client.
<code>OfficeMDB</code> then creates and persists the <code>SetupOffice</code> entity and stores the office information.
<code>EquipmentMDB</code> then finds the entity, stores the equipment information, and learns that the entity has completed its work.
<code>EquipmentMDB</code> then sends the message to the reply queue and removes the entity.</p>
</div>
<div id="_an_enterprise_bean_application_client_to_message_driven_beans_to_entity" class="imageblock">
<div class="content">
<img src="../../common/_images/jakartaeett_dt_038.svg" alt="Diagram of application showing an application client, two message-driven beans, and an entity, as well as the associated topic and queue">
</div>
<div class="title">Figure 1. An Enterprise Bean Application: Client to Message-Driven Beans to Entity</div>
</div>
</div>
<div class="sect2">
<h3 id="_writing_the_application_components_for_the_clientmdbentity_example"><a class="anchor" href="#_writing_the_application_components_for_the_clientmdbentity_example"></a>Writing the Application Components for the clientmdbentity Example</h3>
<div class="paragraph">
<p>Writing the components of the application involves coding the application client, the message-driven beans, and the entity class.</p>
</div>
<div class="sect3">
<h4 id="_coding_the_application_client_humanresourceclient_java"><a class="anchor" href="#_coding_the_application_client_humanresourceclient_java"></a>Coding the Application Client: HumanResourceClient.java</h4>
<div class="paragraph">
<p>The application client, <code>HumanResourceClient.java</code>, found under <code>clientmdbentity-app-client</code>, performs the following steps:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Defines a topic for the application, using the <code>java:app</code> namespace because the topic is used in both the application client and the Jakarta Enterprise Beans module</p>
</li>
<li>
<p>Injects <code>ConnectionFactory</code> and <code>Topic</code> resources</p>
</li>
<li>
<p>Creates a <code>TemporaryQueue</code> to receive notification of processing that occurs, based on new-hire events it has published</p>
</li>
<li>
<p>Creates a <code>JMSConsumer</code> for the <code>TemporaryQueue</code>, sets the <code>JMSConsumer</code>'s message listener, and starts the connection</p>
</li>
<li>
<p>Creates a <code>MapMessage</code></p>
</li>
<li>
<p>Creates five new employees with randomly generated names, positions, and ID numbers (in sequence) and publishes five messages containing this information</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>The message listener, <code>HRListener</code>, waits for messages that contain the assigned office and equipment for each employee.
When a message arrives, the message listener displays the information received and determines whether all five messages have arrived.
When they have, the message listener notifies the <code>main</code> method, which then exits.</p>
</div>
</div>
<div class="sect3">
<h4 id="_coding_the_message_driven_beans_for_the_clientmdbentity_example"><a class="anchor" href="#_coding_the_message_driven_beans_for_the_clientmdbentity_example"></a>Coding the Message-Driven Beans for the clientmdbentity Example</h4>
<div class="paragraph">
<p>This example uses two message-driven beans, both under <code>clientmdbentity-ejb</code>:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>EquipmentMDB.java</code></p>
</li>
<li>
<p><code>OfficeMDB.java</code></p>
</li>
</ul>
</div>
<div class="paragraph">
<p>The beans take the following steps.</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>They inject a <code>MessageDrivenContext</code> resource, an <code>EntityManager</code>, and a <code>JMSContext</code>.</p>
</li>
<li>
<p>The <code>onMessage</code> method retrieves the information in the message.
The <code>EquipmentMDB</code>'s <code>onMessage</code> method chooses equipment, based on the new hire&#8217;s position; the <code>OfficeMDB</code>'s <code>onMessage</code> method randomly generates an office number.</p>
</li>
<li>
<p>After a slight delay to simulate real world processing hitches, the <code>onMessage</code> method calls a helper method, <code>compose</code>.</p>
</li>
<li>
<p>The <code>compose</code> method takes the following steps.</p>
<div class="olist loweralpha">
<ol class="loweralpha" type="a">
<li>
<p>It either creates and persists the <code>SetupOffice</code> entity or finds it by primary key.</p>
</li>
<li>
<p>It uses the entity to store the equipment or the office information in the database, calling either the <code>doEquipmentList</code> or the <code>doOfficeNumber</code> business method.</p>
</li>
<li>
<p>If the business method returns <code>true</code>, meaning that all of the information has been stored, it retrieves the reply destination information from the message, creates a <code>JMSProducer</code>, and sends a reply message that contains the information stored in the entity.</p>
</li>
<li>
<p>It removes the entity.</p>
</li>
</ol>
</div>
</li>
</ol>
</div>
</div>
<div class="sect3">
<h4 id="_coding_the_entity_class_for_the_clientmdbentity_example"><a class="anchor" href="#_coding_the_entity_class_for_the_clientmdbentity_example"></a>Coding the Entity Class for the clientmdbentity Example</h4>
<div class="paragraph">
<p>The <code>SetupOffice.java</code> class, also under <code>clientmdbentity-ejb</code>, is an entity class.
The entity and the message-driven beans are packaged together in an enterprise bean JAR file.
The entity class is declared as follows:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">@Entity
public class SetupOffice implements Serializable { ... }</code></pre>
</div>
</div>
<div class="paragraph">
<p>The class contains a no-argument constructor and a constructor that takes two arguments, the employee ID and name.
It also contains getter and setter methods for the employee ID, name, office number, and equipment list.
The getter method for the employee ID has the <code>@Id</code> annotation to indicate that this field is the primary key:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">@Id
public String getEmployeeId() {
    return id;
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>The class also implements the two business methods, <code>doEquipmentList</code> and <code>doOfficeNumber</code>, and their helper method, <code>checkIfSetupComplete</code>.</p>
</div>
<div class="paragraph">
<p>The message-driven beans call the business methods and the getter methods.</p>
</div>
<div class="paragraph">
<p>The <code>persistence.xml</code> file for the entity specifies the most basic settings:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;?xml version="1.0" encoding="UTF-8"?&gt;
&lt;persistence version="3.0"
             xmlns="https://jakarta.ee/xml/ns/persistence"
             xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
             xsi:schemaLocation="https://jakarta.ee/xml/ns/persistence
               https://jakarta.ee/xml/ns/persistence/persistence_3_0.xsd"&gt;
  &lt;persistence-unit name="clientmdbentity-ejbPU" transaction-type="JTA"&gt;
    &lt;provider&gt;org.eclipse.persistence.jpa.PersistenceProvider&lt;/provider&gt;
    &lt;jta-data-source&gt;java:comp/DefaultDataSource&lt;/jta-data-source&gt;
    &lt;properties&gt;
      &lt;property name="eclipselink.ddl-generation"
                value="drop-and-create-tables"/&gt;
    &lt;/properties&gt;
  &lt;/persistence-unit&gt;
&lt;/persistence&gt;</code></pre>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_running_the_clientmdbentity_example"><a class="anchor" href="#_running_the_clientmdbentity_example"></a>Running the clientmdbentity Example</h3>
<div class="paragraph">
<p>You can use either NetBeans IDE or Maven to build, deploy, and run the <code>clientmdbentity</code> example.</p>
</div>
<div class="paragraph">
<p>Because the example defines its own application-private topic and uses the preconfigured default connection factory <code>java:comp/DefaultJMSConnectionFactory</code> and the preconfigured default JDBC resource <code>java:comp/DefaultDataSource</code>, you do not need to create resources for it.</p>
</div>
<div class="sect3">
<h4 id="_to_run_clientmdbentity_using_netbeans_ide"><a class="anchor" href="#_to_run_clientmdbentity_using_netbeans_ide"></a>To Run clientmdbentity Using NetBeans IDE</h4>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Make sure that GlassFish Server has been started (see <a href="../../intro/usingexamples/usingexamples.html#_starting_and_stopping_glassfish_server" class="xref page">Starting and Stopping GlassFish Server</a>), as well as the database server (see <a href="../../intro/usingexamples/usingexamples.html#_starting_and_stopping_apache_derby" class="xref page">Starting and Stopping Apache Derby</a>).</p>
</li>
<li>
<p>From the <strong>File</strong> menu, choose <strong>Open Project</strong>.</p>
</li>
<li>
<p>In the <strong>Open Project</strong> dialog box, navigate to:</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-asciidoc hljs" data-lang="asciidoc">jakartaee-examples/tutorial/jms/clientmdbentity</code></pre>
</div>
</div>
</li>
<li>
<p>Select the <code>clientmdbentity</code> folder.</p>
</li>
<li>
<p>Click <strong>Open Project</strong>.</p>
</li>
<li>
<p>In the <strong>Projects</strong> tab, right-click the <code>clientmdbentity</code> project and select <strong>Build</strong>.</p>
<div class="paragraph">
<p>This command creates the following:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>An application client JAR file that contains the client class and listener class files, along with a manifest file that specifies the main class</p>
</li>
<li>
<p>An enterprise bean JAR file that contains the message-driven beans and the entity class, along with the <code>persistence.xml</code> file</p>
</li>
<li>
<p>An application EAR file that contains the two JAR files along with an <code>application.xml</code> file</p>
<div class="paragraph">
<p>The <code>clientmdbentity.ear</code> file is created in the <code>clientmdbentity-ear/target/</code> directory.</p>
</div>
<div class="paragraph">
<p>The command then deploys the EAR file, retrieves the client stubs, and runs the application client.</p>
</div>
</li>
</ul>
</div>
</li>
</ol>
</div>
</div>
<div class="sect3">
<h4 id="_to_run_clientmdbentity_using_maven"><a class="anchor" href="#_to_run_clientmdbentity_using_maven"></a>To Run clientmdbentity Using Maven</h4>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Make sure that GlassFish Server has been started (see <a href="../../intro/usingexamples/usingexamples.html#_starting_and_stopping_glassfish_server" class="xref page">Starting and Stopping GlassFish Server</a>), as well as the database server (see <a href="../../intro/usingexamples/usingexamples.html#_starting_and_stopping_apache_derby" class="xref page">Starting and Stopping Apache Derby</a>).</p>
</li>
<li>
<p>Go to the following directory:</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-asciidoc hljs" data-lang="asciidoc">jakartaee-examples/tutorial/jms/clientmdbentity/</code></pre>
</div>
</div>
</li>
<li>
<p>To compile the source files and package, deploy, and run the application, enter the following command:</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">mvn install</code></pre>
</div>
</div>
<div class="paragraph">
<p>This command creates the following:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>An application client JAR file that contains the client class and listener class files, along with a manifest file that specifies the main class</p>
</li>
<li>
<p>An enterprise bean JAR file that contains the message-driven beans and the entity class, along with the <code>persistence.xml</code> file</p>
</li>
<li>
<p>An application EAR file that contains the two JAR files along with an <code>application.xml</code> file</p>
<div class="paragraph">
<p>The command then deploys the application, retrieves the client stubs, and runs the application client.</p>
</div>
</li>
</ul>
</div>
</li>
</ol>
</div>
</div>
<div class="sect3">
<h4 id="_viewing_the_application_output"><a class="anchor" href="#_viewing_the_application_output"></a>Viewing the Application Output</h4>
<div class="paragraph">
<p>The output in the NetBeans IDE output window or in the terminal window looks something like this (preceded by application client container output and Maven output):</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-asciidoc hljs" data-lang="asciidoc">SENDER: Setting hire ID to 50, name Bill Tudor, position Programmer
SENDER: Setting hire ID to 51, name Carol Jones, position Senior Programmer
SENDER: Setting hire ID to 52, name Mark Wilson, position Manager
SENDER: Setting hire ID to 53, name Polly Wren, position Senior Programmer
SENDER: Setting hire ID to 54, name Joe Lawrence, position Director
Waiting for 5 message(s)
New hire event processed:
  Employee ID: 52
  Name: Mark Wilson
  Equipment: Tablet
  Office number: 294
Waiting for 4 message(s)
New hire event processed:
  Employee ID: 53
  Name: Polly Wren
  Equipment: Laptop
  Office number: 186
Waiting for 3 message(s)
New hire event processed:
  Employee ID: 54
  Name: Joe Lawrence
  Equipment: Mobile Phone
  Office number: 135
Waiting for 2 message(s)
New hire event processed:
  Employee ID: 50
  Name: Bill Tudor
  Equipment: Desktop System
  Office number: 200
Waiting for 1 message(s)
New hire event processed:
  Employee ID: 51
  Name: Carol Jones
  Equipment: Laptop
  Office number: 262</code></pre>
</div>
</div>
<div class="paragraph">
<p>The output from the message-driven beans and the entity class appears in the server log.</p>
</div>
<div class="paragraph">
<p>For each employee, the application first creates the entity and then finds it.
You may see runtime errors in the server log, and transaction rollbacks may occur.
The errors occur if both of the message-driven beans discover at the same time that the entity does not yet exist, so they both try to create it.
The first attempt succeeds, but the second fails because the bean already exists.
After the rollback, the second message-driven bean tries again and succeeds in finding the entity.
Container-managed transactions allow the application to run correctly, in spite of these errors, with no special programming.</p>
</div>
<div class="paragraph">
<p>To undeploy the application after you have finished running it, use the Services tab or issue the <code>mvn cargo:undeploy</code> command.</p>
</div>
</div>
</div>
</div>
</div>
</article>
  </div>
</main>
</div>
<footer class="footer">
  <p>This page was built using the Antora default UI.</p>
  <p>The source code for this UI is licensed under the terms of the MPL-2.0 license.</p>
</footer>
<script id="site-script" src="../../../../_/js/site.js" data-ui-root-path="../../../../_"></script>
<script async src="../../../../_/js/vendor/highlight.js"></script>
  </body>
</html>
